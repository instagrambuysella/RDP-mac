name: RDP-mac-manual-auth

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 1440

    steps:
      - name: Create RDP user and generate password
        shell: bash
        run: |
          set -euo pipefail
          PASSWORD=$(python3 -c 'import secrets, string; chars = string.ascii_letters + string.digits + "!@#$%^&*()"; print("".join(secrets.choice(chars) for _ in range(16)))')
          echo "RDP_USER=RDP" >> $GITHUB_ENV
          echo "RDP_PASSWORD=${PASSWORD}" >> $GITHUB_ENV
          sudo sysadminctl -addUser RDP -fullName "RDP User" -password "${PASSWORD}" -admin

      - name: Enable Screen Sharing and set VNC password
        shell: bash
        env:
          RDP_PASSWORD: ${{ env.RDP_PASSWORD }}
        run: |
          VNC_PW="${RDP_PASSWORD:0:8}"

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -users RDP -privs -all -restart -agent -menu

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$VNC_PW" -restart -agent

          echo "VNC_PORT=5900" >> $GITHUB_ENV

      - name: Install Tailscale
        shell: bash
        run: |
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi

          brew install --cask tailscale || brew install tailscale || true

      - name: Start tailscaled (userspace networking)
        shell: bash
        run: |
          sudo tailscaled --tun=userspace-networking > /tmp/tailscaled.log 2>&1 &
          sleep 2

      - name: Use YOUR manual auth link (update this every rerun)
        shell: bash
        run: |
          set -euo pipefail

          ##############################################
          ##  EDIT THIS LINE BEFORE EVERY WORKFLOW RUN
          ##############################################
          AUTH_URL="https://apps.apple.com/ca/app/tailscale/id1475387142?mt=12"
          ##############################################

          echo "Using your manual Tailscale auth URL:"
          echo "$AUTH_URL"
          echo ""
          echo "Open this URL on your Mac / iPhone with Tailscale installed and approve the new device."
          echo "Waiting for approval..."

          # begin tailscale registration WITHOUT authkey (forces interactive mode)
          sudo tailscale up --hostname="gh-mac-${GITHUB_RUN_ID}" --accept-routes=false --accept-dns=false >/tmp/tailscale_up.log 2>&1 &

      - name: Wait for Tailscale IP (after you approve manually)
        shell: bash
        run: |
          MAX_WAIT=1800
          ELAPSED=0

          echo "Waiting for Tailscale IP assignmentâ€¦ (approve using your link)"

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            IP=$(tailscale ip -4 2>/dev/null | head -n1)
            if [ -n "$IP" ]; then
              echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV
              echo "Connected! IP = $IP"
              exit 0
            fi

            sleep 5
            ELAPSED=$((ELAPSED+5))

            if [ $((ELAPSED % 60)) -eq 0 ]; then
              echo "Still waiting... ($ELAPSED sec). Approve using your URL."
            fi
          done

          echo "Timed out waiting for device approval."
          tail -n 200 /tmp/tailscaled.log || true
          exit 1

      - name: Print Access Info + Keep alive
        shell: bash
        env:
          RDP_PASSWORD: ${{ env.RDP_PASSWORD }}
        run: |
          echo "====== macOS RDP/VNC ACCESS ======"
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "User: RDP"
          echo "Password: ${RDP_PASSWORD}"
          echo "VNC Password (first 8 chars): ${RDP_PASSWORD:0:8}"
          echo "Port: 5900"
          echo "=================================="

          while true; do
            echo "[$(date)] macOS runner alive..."
            sleep 300
          done
