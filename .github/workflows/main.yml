name: VNC macOS

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Screen Sharing (VNC)
        run: |
          # Enable VNC/Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw mypassword123 \
            -restart -agent -privs -all
          
          # Enable remote management
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          # Configure VNC password (for legacy VNC clients)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw mypassword123

      - name: Create RDP/VNC User
        run: |
          # Generate random password
          PASSWORD=$(openssl rand -base64 16 | tr -d '=+/' | cut -c1-16)
          USERNAME="remoteuser"
          
          # Create user
          sudo sysadminctl -addUser $USERNAME -password "$PASSWORD" -admin
          
          # Store credentials
          echo "VNC_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV
          echo "Legacy VNC Password: mypassword123" >> $GITHUB_ENV
          
          echo "User created: $USERNAME"
          
      - name: Install Tailscale
        run: |
          # Download and install Tailscale
          TS_URL="https://pkgs.tailscale.com/stable/Tailscale-1.82.0-macos-amd64.zip"
          curl -o tailscale.zip $TS_URL
          unzip tailscale.zip -d /tmp/tailscale
          
          # Install Tailscale
          sudo installer -pkg /tmp/tailscale/Tailscale.pkg -target /
          
          # Clean up
          rm -rf tailscale.zip /tmp/tailscale

      - name: Establish Tailscale Connection
        run: |
          # Start Tailscale
          sudo tailscaled &
          sleep 5
          
          # Connect to Tailscale network
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-macos-${{ github.run_id }}
          
          # Get Tailscale IP
          sleep 10
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"
          
          # Display network info
          tailscale status

      - name: Configure Firewall for VNC
        run: |
          # Allow VNC (port 5900) through firewall
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Support/com.apple.screensharing.agent
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Support/com.apple.screensharing.agent
          
          # Also allow legacy VNC
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Support/vncserver
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Support/vncserver
          
          echo "Firewall configured for VNC"

      - name: Start Screen Sharing Service
        run: |
          # Ensure screen sharing is running
          sudo launchctl unload /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          # Also enable for current user
          sudo launchctl enable system/com.apple.screensharing
          
          echo "Screen Sharing service started"

      - name: Verify VNC Accessibility
        run: |
          echo "Testing VNC connectivity..."
          
          # Check if service is listening
          NETSTAT=$(sudo lsof -i :5900 || echo "Checking...")
          echo "Listening ports:"
          sudo lsof -i :5900 || echo "Port 5900 not found, checking launchctl..."
          
          # Check service status
          sudo launchctl list | grep screensharing || echo "Checking alternative..."
          
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "VNC should be accessible at: ${{ env.TAILSCALE_IP }}:5900"

      - name: Display Connection Instructions
        run: |
          echo ""
          echo "==============================================="
          echo "           macOS VNC ACCESS INFORMATION        "
          echo "==============================================="
          echo "Connect via Tailscale VPN using:"
          echo "VNC Address: ${{ env.TAILSCALE_IP }}:5900"
          echo ""
          echo "Authentication Options:"
          echo "1. For macOS Screen Sharing/VNC Viewer:"
          echo "   Username: $(echo ${{ env.VNC_CREDS }} | cut -d'|' -f1 | cut -d':' -f2-)"
          echo "   Password: $(echo ${{ env.VNC_CREDS }} | cut -d'|' -f2 | cut -d':' -f2-)"
          echo ""
          echo "2. For legacy VNC clients (like RealVNC, TightVNC):"
          echo "   Password: mypassword123"
          echo "   (No username required for legacy VNC)"
          echo ""
          echo "Recommended VNC Clients:"
          echo "- Built-in Screen Sharing app (macOS)"
          echo "- RealVNC Viewer"
          echo "- TigerVNC"
          echo "- Remmina (Linux)"
          echo "==============================================="
          echo ""
          echo "Note: The runner will stay active for 60 minutes"
          echo "or until manually cancelled in GitHub Actions."

      - name: Maintain Connection
        run: |
          # Keep the runner alive
          echo "Runner is active. VNC is available via Tailscale."
          echo "Press Ctrl+C in the workflow log to terminate."
          
          # Simple keep-alive loop
          COUNTER=0
          while [ $COUNTER -lt 720 ]; do  # 720 * 5 seconds = 60 minutes
              echo "[$(date)] VNC session active - ${COUNTER}/720 checks"
              sleep 5
              COUNTER=$((COUNTER + 1))
          done
